<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Listado de visitas</title>
  <link rel="stylesheet" href="css/estilos.css">
</head>
<body>
  <div class="container">
    <h1>Registro de Visitas</h1>
    <div class="actions">
      <a class="btn" href="nuevaVisita.html">+ Nueva visita</a>
      <button id="btnRefresh" class="btn">Actualizar</button>
    </div>

    <table id="visitasTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Fecha inicio</th>
          <th>Fecha fin</th>
          <th>Nombre visita</th>
          <th>Actividad</th>
          <th>Plazo</th>
          <th>Responsable</th>
          <th>Evidencia</th>
          <th>Estado</th>
          <th>Recurrente</th>
        </tr>
      </thead>
      <tbody>
        <!-- Los datos se cargarán aquí mediante JavaScript -->
      </tbody>
    </table>
  </div>

  <script>
    const API_BASE = 'http://localhost/VisitasSuper/backend/index.php';
    const UPLOADS_BASE = 'http://localhost/VisitasSuper/backend/uploads/';

    async function fetchAndRender() {
      try {
        const res = await fetch(`${API_BASE}?resource=visitas`);
        const data = await res.json();
        const tbody = document.querySelector('#visitasTable tbody');
        if (!tbody) return;
        tbody.innerHTML = '';

        // Agrupar visitas por aspecto
        const grupos = {};
        data.forEach(v => {
          const aspecto = v.aspecto || 'Sin aspecto';
          if (!grupos[aspecto]) grupos[aspecto] = [];
          grupos[aspecto].push(v);
        });

        // Renderizar cada grupo
        Object.entries(grupos).forEach(([aspecto, visitas]) => {
          // Fila separadora con el nombre del aspecto (SOLO UNA VEZ)
          const trAspecto = document.createElement('tr');
          trAspecto.className = 'aspecto-header';
          trAspecto.innerHTML = `<td colspan="9">${aspecto}</td>`;
          tbody.appendChild(trAspecto);

          // Filas de visitas bajo ese aspecto
          visitas.forEach(v => {
            const tr = document.createElement('tr');
            
            // Aplicar clase según el estado
            const estadoClass = v.estado === 'Completado' ? 'estado-completado' : 
                               v.estado === 'Pendiente' ? 'estado-pendiente' : '';
            
            tr.innerHTML = `
              <td>${v.id}</td>
              <td>${v.fecha_inicio ?? ''}</td>
              <td>${v.fecha_fin ?? ''}</td>
              <td>${v.nombre_visita ?? ''}</td>
              <td>${v.actividad ?? ''}</td>
              <td>${v.plazo_fecha ?? ''}</td>
              <td>${v.responsable ?? ''}</td>
              <td>
                ${v.evidencia 
                  ? `<img src="${UPLOADS_BASE}${v.evidencia}" width="80" height="60" alt="Evidencia">`
                  : '<span class="sin-imagen">Sin imagen</span>'}
              </td>
              <td class="${estadoClass}">${v.estado ?? ''}</td>
            `;
            tbody.appendChild(tr);
          });
        });
      } catch (err) {
        alert('Error al obtener visitas: ' + err);
      }
    }

    // Inicializar
    document.addEventListener('DOMContentLoaded', function() {
      fetchAndRender();
      document.getElementById('btnRefresh').addEventListener('click', fetchAndRender);
    });
  </script>
</body>
</html>