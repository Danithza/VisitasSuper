<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Listado de visitas</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f8f9fa;
      color: #333;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 2px solid #3498db;
    }
    .actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      background-color: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .btn {
      display: inline-block;
      padding: 10px 20px;
      background-color: #3498db;
      color: white;
      text-decoration: none;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s;
    }
    .btn:hover {
      background-color: #2980b9;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #2c3e50;
      color: white;
      font-weight: bold;
    }
    tr:hover {
      background-color: #f5f5f5;
    }
    .aspecto-header {
      background-color: #d6eaf8 !important;
      font-weight: bold;
      font-size: 1.1em;
      text-align: center;
      color: #2c3e50;
    }
    .aspecto-header td {
      border-top: 2px solid #3498db;
      border-bottom: 2px solid #3498db;
      padding: 15px;
    }
    img {
      border-radius: 4px;
      border: 1px solid #ddd;
      transition: transform 0.3s;
    }
    img:hover {
      transform: scale(1.05);
    }
    .estado-pendiente {
      color: #e74c3c;
      font-weight: bold;
    }
    .estado-completado {
      color: #27ae60;
      font-weight: bold;
    }
    .sin-imagen {
      color: #7f8c8d;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Registro de Visitas</h1>
    <div class="actions">
      <a class="btn" href="nuevaVisita.html">+ Nueva visita</a>
      <button id="btnRefresh" class="btn">Actualizar</button>
    </div>

    <table id="visitasTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Fecha inicio</th>
          <th>Fecha fin</th>
          <th>Nombre visita</th>
          <th>Actividad</th>
          <th>Plazo</th>
          <th>Responsable</th>
          <th>Evidencia</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody>
        <!-- Los datos se cargarán aquí mediante JavaScript -->
      </tbody>
    </table>
  </div>

  <script>
    const API_BASE = 'http://localhost/VisitasSuper/backend/index.php';
    const UPLOADS_BASE = 'http://localhost/VisitasSuper/backend/uploads/';

    async function fetchAndRender() {
      try {
        const res = await fetch(`${API_BASE}?resource=visitas`);
        const data = await res.json();
        const tbody = document.querySelector('#visitasTable tbody');
        if (!tbody) return;
        tbody.innerHTML = '';

        // Agrupar visitas por aspecto
        const grupos = {};
        data.forEach(v => {
          const aspecto = v.aspecto || 'Sin aspecto';
          if (!grupos[aspecto]) grupos[aspecto] = [];
          grupos[aspecto].push(v);
        });

        // Renderizar cada grupo
        Object.entries(grupos).forEach(([aspecto, visitas]) => {
          // Fila separadora con el nombre del aspecto (SOLO UNA VEZ)
          const trAspecto = document.createElement('tr');
          trAspecto.className = 'aspecto-header';
          trAspecto.innerHTML = `<td colspan="9">${aspecto}</td>`;
          tbody.appendChild(trAspecto);

          // Filas de visitas bajo ese aspecto
          visitas.forEach(v => {
            const tr = document.createElement('tr');
            
            // Aplicar clase según el estado
            const estadoClass = v.estado === 'Completado' ? 'estado-completado' : 
                               v.estado === 'Pendiente' ? 'estado-pendiente' : '';
            
            tr.innerHTML = `
              <td>${v.id}</td>
              <td>${v.fecha_inicio ?? ''}</td>
              <td>${v.fecha_fin ?? ''}</td>
              <td>${v.nombre_visita ?? ''}</td>
              <td>${v.actividad ?? ''}</td>
              <td>${v.plazo_fecha ?? ''}</td>
              <td>${v.responsable ?? ''}</td>
              <td>
                ${v.evidencia 
                  ? `<img src="${UPLOADS_BASE}${v.evidencia}" width="80" height="60" alt="Evidencia">`
                  : '<span class="sin-imagen">Sin imagen</span>'}
              </td>
              <td class="${estadoClass}">${v.estado ?? ''}</td>
            `;
            tbody.appendChild(tr);
          });
        });
      } catch (err) {
        alert('Error al obtener visitas: ' + err);
      }
    }

    // Inicializar
    document.addEventListener('DOMContentLoaded', function() {
      fetchAndRender();
      document.getElementById('btnRefresh').addEventListener('click', fetchAndRender);
    });
  </script>
</body>
</html>